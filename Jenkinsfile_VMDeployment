pipeline {
    agent any

    triggers{
        githubPush()  /* Webhook trigger for GitHub repository */
    }

    environment{
        NGINX_SERVER_SSH_KEY = "Nginx-Server-SSHKey"
        NGINX_SERVER_IP = "172.31.25.58"
        SSH_USER = "ec2-user"
    }

    options{
        timeout(time: 30, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '5'))
    }

    stages{
        stage('git checkout'){
            steps{
                checkout scm
            }
        }

        stage('Deploy to Nginx Server'){
            steps{
                sshagent(['Nginx-Server-SSHKey']) {
                    sshagent(['Nginx-Server-SSHKey']) {
                        sh """
                        echo "deploying to nginx server......"
                        ssh -o StrictHostKeyChecking=no ${SSH_USER}@${NGINX_SERVER_IP} sudo rm -rf /usr/share/nginx/html/*
                        scp -o StrictHostKeyChecking=no -r * ${SSH_USER}@${NGINX_SERVER_IP}:/usr/share/nginx/html/
                        echo "restarting nginx server......"
                        sleep 5
                        ssh -o StrictHostKeyChecking=no ${SSH_USER}@${NGINX_SERVER_IP} sudo systemctl restart nginx
                        """
                        }
                    }
                }
        }
    }
    post{
        always{
            cleanWs()
        }
        success{
            echo "Deployment Successful!"
        }
        failure{
            echo "Deployment Failed!"
        }
    }
}
